How to categorize this PR?

/area monitoring
/kind enhancement

What this PR does / why we need it:

This PR allows the upgrade of the kube-state-metrics to the latest version, as of today v2.12.0. The upgrade was not possible because of the deprecation of the VPA metrics, which are now supposed to be configured as any other custom resource by using a so-called CustomResourceState feature from the kube-state-metrics. This is a mechanism to tell kube-state-metrics via configuration which keys and values from custom resource spec files need to be mapped into which metrics.

Special notes for your reviewer:

In the first commits from this PR, the new VPA metrics configuration is inlined but later on mounted into a file in the kube-state-metrics pod via a config map. ? We tried to preserve the old metric labels and naming as much as possible. However, there are a few changes:

Maybe use an example instead of the detailed explanation below.

    We can't have one common metric for several resources (e.g., CPU and memory) and distinguish between them via labels. Instead, we need to migrate to one specific metric per resource. For instance, previously we would have a target metric with labels resource=cpu or resource=memory to indicate the value corresponding to CPU or memory. After this change two metrics are added: target_cpu and target_memory. Nevertheless, we consider this as an improvement because values in the new metrics are not mixing units as before (cores were used for the CPU and bytes for the memory).
    Using CustomResourceState prefixes the metric name with kube_customresource by default. Therefore, the old prefix kube_verticalpodautoscaler becomes now kube_customresource_verticalpodautoscaler. Such default prefix can be overwritten to match the one we want, but we choose not to so that the new name reflects better that the metric is generated by the CustomResourceState
    Property nilIsZero is set to true for the recommendation metrics to set the value to zero if the recommendation path does not exist in the VPA spec file (i.e., it doesn't have a recommendation). In the past, the time series would simply not exist. Since a recommendation to 0 does not make sense, this is a way, e.g., in the dashboard, to know there is no recommendation at all, rather than relying on not having data, which could also be the case if there is an issue and metrics are missing.
    Metrics containing container_policies in their name have been renamed to containerpolicies to respect the containerPolicies key in the spec file (similar to resourcePolicy or containerRecommendations). This way, the metric format is unified to use underscores to separate keys in the path.
    The CustomResourceState documentation does not mention that kube-state-metrics needs get permissions on RBAC-enabled clusters, but only list and watch. Therefore, the old get permissions are removed.

Finally, as for the unit tests, it became a bit tricky to assert that the CustomResourceState configuration matches the expectation because it is about 300 lines long and (a) the ginkgo default configuration will cut the output if the diff is too long in case of test failure and, (b) a long diff is almost an impossible task for the naked eye without additional tooling support. It is for this reason that we decided for a rather unorthodox way to help in this regard.

The expected configuration is stored in a proper YAML file and committed to the repository. When a test that requires validating the CustomResourceState configuration runs (e.g., a test that validates that the new config map is part of the managed resource and contains the right data), it calls a helper function expectedCustomResourceStateConfig() to load this file, which is the test expectation. This function, however, also loads the actual configuration generated by the current code, stores it in a file in the temporary directory and matches it against the expectation. If that succeeds, the test will run. If not, the test will be aborted and a help message will be printed by ginkgo with a diff command to compare both files. It is then up to the developer to compare both files and fix the test accordingly (e.g., replace the expectation file with the new one because the old expectation is not correct anymore). Reviewers can find below and example of this test output.
Example of test failure

Screenshot 2024-06-06 at 16 30 03

/cc @istvanballok @rickardsjp
/fyi @rfranzke @voelzmo

Release note:

Migrate VPA metrics to CustomResourceState metrics and upgrade kube-state-metrics to v2.12.0

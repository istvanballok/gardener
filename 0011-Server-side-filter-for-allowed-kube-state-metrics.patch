From 96fc635e7125685d9f80cd602ddab79400585636 Mon Sep 17 00:00:00 2001
From: Victor Herrero Otal <victor.herrero.otal@sap.com>
Date: Fri, 12 Jul 2024 14:14:39 +0200
Subject: [PATCH 11/11] Server-side filter for allowed kube state metrics

TODO(vicwicker): Add commit text.
---
 .../kubestatemetrics/kubestatemetrics_test.go | 181 ++++++++-----
 .../monitoring/kubestatemetrics/resources.go  | 243 +++++++++---------
 2 files changed, 236 insertions(+), 188 deletions(-)

diff --git a/pkg/component/observability/monitoring/kubestatemetrics/kubestatemetrics_test.go b/pkg/component/observability/monitoring/kubestatemetrics/kubestatemetrics_test.go
index 2c4e3dd89..7ebf44d2d 100644
--- a/pkg/component/observability/monitoring/kubestatemetrics/kubestatemetrics_test.go
+++ b/pkg/component/observability/monitoring/kubestatemetrics/kubestatemetrics_test.go
@@ -241,64 +241,64 @@ var _ = Describe("KubeStateMetrics", func() {
 					"--metric-labels-allowlist=nodes=[*],pods=[origin]",
 					"--metric-annotations-allowlist=namespaces=[shoot.gardener.cloud/uid]",
 					"--metric-allowlist=" +
-						"kube_daemonset_metadata_generation," +
-						"kube_daemonset_status_current_number_scheduled," +
-						"kube_daemonset_status_desired_number_scheduled," +
-						"kube_daemonset_status_number_available," +
-						"kube_daemonset_status_number_unavailable," +
-						"kube_daemonset_status_updated_number_scheduled," +
-						"kube_deployment_metadata_generation," +
-						"kube_deployment_spec_replicas," +
-						"kube_deployment_status_observed_generation," +
-						"kube_deployment_status_replicas," +
-						"kube_deployment_status_replicas_available," +
-						"kube_deployment_status_replicas_unavailable," +
-						"kube_deployment_status_replicas_updated," +
-						"kube_horizontalpodautoscaler_spec_max_replicas," +
-						"kube_horizontalpodautoscaler_spec_min_replicas," +
-						"kube_horizontalpodautoscaler_status_current_replicas," +
-						"kube_horizontalpodautoscaler_status_desired_replicas," +
-						"kube_horizontalpodautoscaler_status_condition," +
-						"kube_namespace_annotations," +
-						"kube_node_info," +
-						"kube_node_labels," +
-						"kube_node_spec_taint," +
-						"kube_node_spec_unschedulable," +
-						"kube_node_status_allocatable," +
-						"kube_node_status_capacity," +
-						"kube_node_status_condition," +
-						"kube_persistentvolumeclaim_resource_requests_storage_bytes," +
-						"kube_pod_container_info," +
-						"kube_pod_container_resource_limits," +
-						"kube_pod_container_resource_requests," +
-						"kube_pod_container_status_restarts_total," +
-						"kube_pod_info," +
-						"kube_pod_labels," +
-						"kube_pod_owner," +
-						"kube_pod_spec_volumes_persistentvolumeclaims_info," +
-						"kube_pod_status_phase," +
-						"kube_pod_status_ready," +
-						"kube_replicaset_owner," +
-						"kube_statefulset_metadata_generation," +
-						"kube_statefulset_replicas," +
-						"kube_statefulset_status_observed_generation," +
-						"kube_statefulset_status_replicas," +
-						"kube_statefulset_status_replicas_current," +
-						"kube_statefulset_status_replicas_ready," +
-						"kube_statefulset_status_replicas_updated," +
-						"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_cpu," +
-						"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_memory," +
-						"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_cpu," +
-						"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_memory," +
-						"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_cpu," +
-						"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_memory," +
-						"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_cpu," +
-						"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_memory," +
-						"kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_cpu," +
-						"kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_memory," +
-						"kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_cpu," +
-						"kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_memory," +
-						"kube_customresource_verticalpodautoscaler_spec_updatepolicy_updatemode",
+						"^kube_daemonset_metadata_generation$," +
+						"^kube_daemonset_status_current_number_scheduled$," +
+						"^kube_daemonset_status_desired_number_scheduled$," +
+						"^kube_daemonset_status_number_available$," +
+						"^kube_daemonset_status_number_unavailable$," +
+						"^kube_daemonset_status_updated_number_scheduled$," +
+						"^kube_deployment_metadata_generation$," +
+						"^kube_deployment_spec_replicas$," +
+						"^kube_deployment_status_observed_generation$," +
+						"^kube_deployment_status_replicas$," +
+						"^kube_deployment_status_replicas_available$," +
+						"^kube_deployment_status_replicas_unavailable$," +
+						"^kube_deployment_status_replicas_updated$," +
+						"^kube_horizontalpodautoscaler_spec_max_replicas$," +
+						"^kube_horizontalpodautoscaler_spec_min_replicas$," +
+						"^kube_horizontalpodautoscaler_status_current_replicas$," +
+						"^kube_horizontalpodautoscaler_status_desired_replicas$," +
+						"^kube_horizontalpodautoscaler_status_condition$," +
+						"^kube_namespace_annotations$," +
+						"^kube_node_info$," +
+						"^kube_node_labels$," +
+						"^kube_node_spec_taint$," +
+						"^kube_node_spec_unschedulable$," +
+						"^kube_node_status_allocatable$," +
+						"^kube_node_status_capacity$," +
+						"^kube_node_status_condition$," +
+						"^kube_persistentvolumeclaim_resource_requests_storage_bytes$," +
+						"^kube_pod_container_info$," +
+						"^kube_pod_container_resource_limits$," +
+						"^kube_pod_container_resource_requests$," +
+						"^kube_pod_container_status_restarts_total$," +
+						"^kube_pod_info$," +
+						"^kube_pod_labels$," +
+						"^kube_pod_owner$," +
+						"^kube_pod_spec_volumes_persistentvolumeclaims_info$," +
+						"^kube_pod_status_phase$," +
+						"^kube_pod_status_ready$," +
+						"^kube_replicaset_owner$," +
+						"^kube_statefulset_metadata_generation$," +
+						"^kube_statefulset_replicas$," +
+						"^kube_statefulset_status_observed_generation$," +
+						"^kube_statefulset_status_replicas$," +
+						"^kube_statefulset_status_replicas_current$," +
+						"^kube_statefulset_status_replicas_ready$," +
+						"^kube_statefulset_status_replicas_updated$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_cpu$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_memory$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_cpu$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_memory$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_cpu$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_memory$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_cpu$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_memory$," +
+						"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_cpu$," +
+						"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_memory$," +
+						"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_cpu$," +
+						"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_memory$," +
+						"^kube_customresource_verticalpodautoscaler_spec_updatepolicy_updatemode$",
 					"--custom-resource-state-config-file=/config/custom-resource-state.yaml",
 				}
 				serviceAccountName = "kube-state-metrics"
@@ -341,6 +341,61 @@ var _ = Describe("KubeStateMetrics", func() {
 					"--namespaces=kube-system",
 					"--kubeconfig=/var/run/secrets/gardener.cloud/shoot/generic-kubeconfig/kubeconfig",
 					"--metric-labels-allowlist=nodes=[*],pods=[origin]",
+					"--metric-allowlist=" +
+						"^kube_daemonset_metadata_generation$," +
+						"^kube_daemonset_status_current_number_scheduled$," +
+						"^kube_daemonset_status_desired_number_scheduled$," +
+						"^kube_daemonset_status_number_available$," +
+						"^kube_daemonset_status_number_unavailable$," +
+						"^kube_daemonset_status_updated_number_scheduled$," +
+						"^kube_deployment_metadata_generation$," +
+						"^kube_deployment_spec_replicas$," +
+						"^kube_deployment_status_observed_generation$," +
+						"^kube_deployment_status_replicas$," +
+						"^kube_deployment_status_replicas_available$," +
+						"^kube_deployment_status_replicas_unavailable$," +
+						"^kube_deployment_status_replicas_updated$," +
+						"^kube_node_info$," +
+						"^kube_node_labels$," +
+						"^kube_node_spec_taint$," +
+						"^kube_node_spec_unschedulable$," +
+						"^kube_node_status_allocatable$," +
+						"^kube_node_status_capacity$," +
+						"^kube_node_status_condition$," +
+						"^kube_pod_container_info$," +
+						"^kube_pod_container_resource_limits$," +
+						"^kube_pod_container_resource_requests$," +
+						"^kube_pod_container_status_restarts_total$," +
+						"^kube_pod_info$," +
+						"^kube_pod_labels$," +
+						"^kube_pod_status_phase$," +
+						"^kube_pod_status_ready$," +
+						"^kube_replicaset_owner$," +
+						"^kube_replicaset_metadata_generation$," +
+						"^kube_replicaset_spec_replicas$," +
+						"^kube_replicaset_status_observed_generation$," +
+						"^kube_replicaset_status_replicas$," +
+						"^kube_replicaset_status_ready_replicas$," +
+						"^kube_statefulset_metadata_generation$," +
+						"^kube_statefulset_replicas$," +
+						"^kube_statefulset_status_observed_generation$," +
+						"^kube_statefulset_status_replicas$," +
+						"^kube_statefulset_status_replicas_current$," +
+						"^kube_statefulset_status_replicas_ready$," +
+						"^kube_statefulset_status_replicas_updated$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_cpu$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_memory$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_cpu$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_memory$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_cpu$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_memory$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_cpu$," +
+						"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_memory$," +
+						"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_cpu$," +
+						"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_memory$," +
+						"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_cpu$," +
+						"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_memory$," +
+						"^kube_customresource_verticalpodautoscaler_spec_updatepolicy_updatemode$",
 					"--custom-resource-state-config-file=/config/custom-resource-state.yaml",
 				}
 				automountServiceAccountToken = ptr.To(false)
@@ -499,11 +554,6 @@ var _ = Describe("KubeStateMetrics", func() {
 						Regex:        `^.+\.tf-pod.+$`,
 						Action:       "drop",
 					},
-					{
-						SourceLabels: []monitoringv1.LabelName{"__name__"},
-						Action:       "keep",
-						Regex:        `^(kube_daemonset_metadata_generation|kube_daemonset_status_current_number_scheduled|kube_daemonset_status_desired_number_scheduled|kube_daemonset_status_number_available|kube_daemonset_status_number_unavailable|kube_daemonset_status_updated_number_scheduled|kube_deployment_metadata_generation|kube_deployment_spec_replicas|kube_deployment_status_observed_generation|kube_deployment_status_replicas|kube_deployment_status_replicas_available|kube_deployment_status_replicas_unavailable|kube_deployment_status_replicas_updated|kube_horizontalpodautoscaler_spec_max_replicas|kube_horizontalpodautoscaler_spec_min_replicas|kube_horizontalpodautoscaler_status_current_replicas|kube_horizontalpodautoscaler_status_desired_replicas|kube_horizontalpodautoscaler_status_condition|kube_namespace_annotations|kube_node_info|kube_node_labels|kube_node_spec_taint|kube_node_spec_unschedulable|kube_node_status_allocatable|kube_node_status_capacity|kube_node_status_condition|kube_persistentvolumeclaim_resource_requests_storage_bytes|kube_pod_container_info|kube_pod_container_resource_limits|kube_pod_container_resource_requests|kube_pod_container_status_restarts_total|kube_pod_info|kube_pod_labels|kube_pod_owner|kube_pod_spec_volumes_persistentvolumeclaims_info|kube_pod_status_phase|kube_pod_status_ready|kube_replicaset_owner|kube_statefulset_metadata_generation|kube_statefulset_replicas|kube_statefulset_status_observed_generation|kube_statefulset_status_replicas|kube_statefulset_status_replicas_current|kube_statefulset_status_replicas_ready|kube_statefulset_status_replicas_updated|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_cpu|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_memory|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_cpu|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_memory|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_cpu|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_memory|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_cpu|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_memory|kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_cpu|kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_memory|kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_cpu|kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_memory|kube_customresource_verticalpodautoscaler_spec_updatepolicy_updatemode)$`,
-					},
 				},
 			},
 		}
@@ -635,11 +685,6 @@ var _ = Describe("KubeStateMetrics", func() {
 						Regex:        `^.+\.tf-pod.+$`,
 						Action:       "drop",
 					},
-					{
-						SourceLabels: []monitoringv1.LabelName{"__name__"},
-						Action:       "keep",
-						Regex:        `^(kube_daemonset_metadata_generation|kube_daemonset_status_current_number_scheduled|kube_daemonset_status_desired_number_scheduled|kube_daemonset_status_number_available|kube_daemonset_status_number_unavailable|kube_daemonset_status_updated_number_scheduled|kube_deployment_metadata_generation|kube_deployment_spec_replicas|kube_deployment_status_observed_generation|kube_deployment_status_replicas|kube_deployment_status_replicas_available|kube_deployment_status_replicas_unavailable|kube_deployment_status_replicas_updated|kube_node_info|kube_node_labels|kube_node_spec_taint|kube_node_spec_unschedulable|kube_node_status_allocatable|kube_node_status_capacity|kube_node_status_condition|kube_pod_container_info|kube_pod_container_resource_limits|kube_pod_container_resource_requests|kube_pod_container_status_restarts_total|kube_pod_info|kube_pod_labels|kube_pod_status_phase|kube_pod_status_ready|kube_replicaset_owner|kube_replicaset_metadata_generation|kube_replicaset_spec_replicas|kube_replicaset_status_observed_generation|kube_replicaset_status_replicas|kube_replicaset_status_ready_replicas|kube_statefulset_metadata_generation|kube_statefulset_replicas|kube_statefulset_status_observed_generation|kube_statefulset_status_replicas|kube_statefulset_status_replicas_current|kube_statefulset_status_replicas_ready|kube_statefulset_status_replicas_updated|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_cpu|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_memory|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_cpu|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_memory|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_cpu|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_memory|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_cpu|kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_memory|kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_cpu|kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_memory|kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_cpu|kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_memory|kube_customresource_verticalpodautoscaler_spec_updatepolicy_updatemode)$`,
-					},
 				},
 			},
 		}
diff --git a/pkg/component/observability/monitoring/kubestatemetrics/resources.go b/pkg/component/observability/monitoring/kubestatemetrics/resources.go
index 2b1a12cdc..c20c86563 100644
--- a/pkg/component/observability/monitoring/kubestatemetrics/resources.go
+++ b/pkg/component/observability/monitoring/kubestatemetrics/resources.go
@@ -244,7 +244,7 @@ func (k *kubeStateMetrics) reconcileDeployment(
 			"--resources=deployments,pods,statefulsets,nodes,horizontalpodautoscalers,persistentvolumeclaims,replicasets,namespaces",
 			"--metric-labels-allowlist=nodes=[*],pods=[origin]",
 			"--metric-annotations-allowlist=namespaces=[shoot.gardener.cloud/uid]",
-			"--metric-allowlist="+strings.Join(cachePrometheusAllowedMetrics, ","),
+			"--metric-allowlist="+strings.Join(cacheAllowedMetrics, ","),
 			"--custom-resource-state-config-file="+customResourceStateConfigFile,
 		)
 	}
@@ -259,6 +259,7 @@ func (k *kubeStateMetrics) reconcileDeployment(
 			"--namespaces="+metav1.NamespaceSystem,
 			"--kubeconfig="+gardenerutils.PathGenericKubeconfig,
 			"--metric-labels-allowlist=nodes=[*],pods=[origin]",
+			"--metric-allowlist="+strings.Join(shootAllowedMetrics, ","),
 			"--custom-resource-state-config-file="+customResourceStateConfigFile,
 		)
 	}
@@ -391,7 +392,7 @@ func (k *kubeStateMetrics) reconcilePodDisruptionBudget(podDisruptionBudget *pol
 	kubernetesutils.SetAlwaysAllowEviction(podDisruptionBudget, k.values.KubernetesVersion)
 }
 
-func (k *kubeStateMetrics) standardScrapeConfigSpec(allowedMetrics ...string) monitoringv1alpha1.ScrapeConfigSpec {
+func (k *kubeStateMetrics) standardScrapeConfigSpec() monitoringv1alpha1.ScrapeConfigSpec {
 	return monitoringv1alpha1.ScrapeConfigSpec{
 		KubernetesSDConfigs: []monitoringv1alpha1.KubernetesSDConfig{{
 			// Service is used, because we only care about metric from one kube-state-metrics instance and not multiple
@@ -424,73 +425,130 @@ func (k *kubeStateMetrics) standardScrapeConfigSpec(allowedMetrics ...string) mo
 				Replacement: ptr.To("kube-state-metrics"),
 			},
 		},
-		MetricRelabelConfigs: append([]monitoringv1.RelabelConfig{{
+		MetricRelabelConfigs: []monitoringv1.RelabelConfig{{
 			SourceLabels: []monitoringv1.LabelName{"pod"},
 			Regex:        `^.+\.tf-pod.+$`,
 			Action:       "drop",
-		}}, monitoringutils.StandardMetricRelabelConfig(allowedMetrics...)...),
+		}},
 	}
 }
 
-var cachePrometheusAllowedMetrics = []string{
-	"kube_daemonset_metadata_generation",
-	"kube_daemonset_status_current_number_scheduled",
-	"kube_daemonset_status_desired_number_scheduled",
-	"kube_daemonset_status_number_available",
-	"kube_daemonset_status_number_unavailable",
-	"kube_daemonset_status_updated_number_scheduled",
-	"kube_deployment_metadata_generation",
-	"kube_deployment_spec_replicas",
-	"kube_deployment_status_observed_generation",
-	"kube_deployment_status_replicas",
-	"kube_deployment_status_replicas_available",
-	"kube_deployment_status_replicas_unavailable",
-	"kube_deployment_status_replicas_updated",
-	"kube_horizontalpodautoscaler_spec_max_replicas",
-	"kube_horizontalpodautoscaler_spec_min_replicas",
-	"kube_horizontalpodautoscaler_status_current_replicas",
-	"kube_horizontalpodautoscaler_status_desired_replicas",
-	"kube_horizontalpodautoscaler_status_condition",
-	"kube_namespace_annotations",
-	"kube_node_info",
-	"kube_node_labels",
-	"kube_node_spec_taint",
-	"kube_node_spec_unschedulable",
-	"kube_node_status_allocatable",
-	"kube_node_status_capacity",
-	"kube_node_status_condition",
-	"kube_persistentvolumeclaim_resource_requests_storage_bytes",
-	"kube_pod_container_info",
-	"kube_pod_container_resource_limits",
-	"kube_pod_container_resource_requests",
-	"kube_pod_container_status_restarts_total",
-	"kube_pod_info",
-	"kube_pod_labels",
-	"kube_pod_owner",
-	"kube_pod_spec_volumes_persistentvolumeclaims_info",
-	"kube_pod_status_phase",
-	"kube_pod_status_ready",
-	"kube_replicaset_owner",
-	"kube_statefulset_metadata_generation",
-	"kube_statefulset_replicas",
-	"kube_statefulset_status_observed_generation",
-	"kube_statefulset_status_replicas",
-	"kube_statefulset_status_replicas_current",
-	"kube_statefulset_status_replicas_ready",
-	"kube_statefulset_status_replicas_updated",
-	"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_cpu",
-	"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_memory",
-	"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_cpu",
-	"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_memory",
-	"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_cpu",
-	"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_memory",
-	"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_cpu",
-	"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_memory",
-	"kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_cpu",
-	"kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_memory",
-	"kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_cpu",
-	"kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_memory",
-	"kube_customresource_verticalpodautoscaler_spec_updatepolicy_updatemode",
+var shootAllowedMetrics = []string{
+	"^kube_daemonset_metadata_generation$",
+	"^kube_daemonset_status_current_number_scheduled$",
+	"^kube_daemonset_status_desired_number_scheduled$",
+	"^kube_daemonset_status_number_available$",
+	"^kube_daemonset_status_number_unavailable$",
+	"^kube_daemonset_status_updated_number_scheduled$",
+	"^kube_deployment_metadata_generation$",
+	"^kube_deployment_spec_replicas$",
+	"^kube_deployment_status_observed_generation$",
+	"^kube_deployment_status_replicas$",
+	"^kube_deployment_status_replicas_available$",
+	"^kube_deployment_status_replicas_unavailable$",
+	"^kube_deployment_status_replicas_updated$",
+	"^kube_node_info$",
+	"^kube_node_labels$",
+	"^kube_node_spec_taint$",
+	"^kube_node_spec_unschedulable$",
+	"^kube_node_status_allocatable$",
+	"^kube_node_status_capacity$",
+	"^kube_node_status_condition$",
+	"^kube_pod_container_info$",
+	"^kube_pod_container_resource_limits$",
+	"^kube_pod_container_resource_requests$",
+	"^kube_pod_container_status_restarts_total$",
+	"^kube_pod_info$",
+	"^kube_pod_labels$",
+	"^kube_pod_status_phase$",
+	"^kube_pod_status_ready$",
+	"^kube_replicaset_owner$",
+	"^kube_replicaset_metadata_generation$",
+	"^kube_replicaset_spec_replicas$",
+	"^kube_replicaset_status_observed_generation$",
+	"^kube_replicaset_status_replicas$",
+	"^kube_replicaset_status_ready_replicas$",
+	"^kube_statefulset_metadata_generation$",
+	"^kube_statefulset_replicas$",
+	"^kube_statefulset_status_observed_generation$",
+	"^kube_statefulset_status_replicas$",
+	"^kube_statefulset_status_replicas_current$",
+	"^kube_statefulset_status_replicas_ready$",
+	"^kube_statefulset_status_replicas_updated$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_cpu$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_memory$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_cpu$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_memory$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_cpu$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_memory$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_cpu$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_memory$",
+	"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_cpu$",
+	"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_memory$",
+	"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_cpu$",
+	"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_memory$",
+	"^kube_customresource_verticalpodautoscaler_spec_updatepolicy_updatemode$",
+}
+
+var cacheAllowedMetrics = []string{
+	"^kube_daemonset_metadata_generation$",
+	"^kube_daemonset_status_current_number_scheduled$",
+	"^kube_daemonset_status_desired_number_scheduled$",
+	"^kube_daemonset_status_number_available$",
+	"^kube_daemonset_status_number_unavailable$",
+	"^kube_daemonset_status_updated_number_scheduled$",
+	"^kube_deployment_metadata_generation$",
+	"^kube_deployment_spec_replicas$",
+	"^kube_deployment_status_observed_generation$",
+	"^kube_deployment_status_replicas$",
+	"^kube_deployment_status_replicas_available$",
+	"^kube_deployment_status_replicas_unavailable$",
+	"^kube_deployment_status_replicas_updated$",
+	"^kube_horizontalpodautoscaler_spec_max_replicas$",
+	"^kube_horizontalpodautoscaler_spec_min_replicas$",
+	"^kube_horizontalpodautoscaler_status_current_replicas$",
+	"^kube_horizontalpodautoscaler_status_desired_replicas$",
+	"^kube_horizontalpodautoscaler_status_condition$",
+	"^kube_namespace_annotations$",
+	"^kube_node_info$",
+	"^kube_node_labels$",
+	"^kube_node_spec_taint$",
+	"^kube_node_spec_unschedulable$",
+	"^kube_node_status_allocatable$",
+	"^kube_node_status_capacity$",
+	"^kube_node_status_condition$",
+	"^kube_persistentvolumeclaim_resource_requests_storage_bytes$",
+	"^kube_pod_container_info$",
+	"^kube_pod_container_resource_limits$",
+	"^kube_pod_container_resource_requests$",
+	"^kube_pod_container_status_restarts_total$",
+	"^kube_pod_info$",
+	"^kube_pod_labels$",
+	"^kube_pod_owner$",
+	"^kube_pod_spec_volumes_persistentvolumeclaims_info$",
+	"^kube_pod_status_phase$",
+	"^kube_pod_status_ready$",
+	"^kube_replicaset_owner$",
+	"^kube_statefulset_metadata_generation$",
+	"^kube_statefulset_replicas$",
+	"^kube_statefulset_status_observed_generation$",
+	"^kube_statefulset_status_replicas$",
+	"^kube_statefulset_status_replicas_current$",
+	"^kube_statefulset_status_replicas_ready$",
+	"^kube_statefulset_status_replicas_updated$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_cpu$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_memory$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_cpu$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_memory$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_cpu$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_memory$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_cpu$",
+	"^kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_memory$",
+	"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_cpu$",
+	"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_memory$",
+	"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_cpu$",
+	"^kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_memory$",
+	"^kube_customresource_verticalpodautoscaler_spec_updatepolicy_updatemode$",
 }
 
 func (k *kubeStateMetrics) emptyScrapeConfigCache() *monitoringv1alpha1.ScrapeConfig {
@@ -499,7 +557,7 @@ func (k *kubeStateMetrics) emptyScrapeConfigCache() *monitoringv1alpha1.ScrapeCo
 
 func (k *kubeStateMetrics) reconcileScrapeConfigCache(scrapeConfig *monitoringv1alpha1.ScrapeConfig) {
 	scrapeConfig.Labels = monitoringutils.Labels(cache.Label)
-	scrapeConfig.Spec = k.standardScrapeConfigSpec(cachePrometheusAllowedMetrics...)
+	scrapeConfig.Spec = k.standardScrapeConfigSpec()
 }
 
 func (k *kubeStateMetrics) emptyScrapeConfigSeed() *monitoringv1alpha1.ScrapeConfig {
@@ -594,62 +652,7 @@ func (k *kubeStateMetrics) emptyScrapeConfigShoot() *monitoringv1alpha1.ScrapeCo
 
 func (k *kubeStateMetrics) reconcileScrapeConfigShoot(scrapeConfig *monitoringv1alpha1.ScrapeConfig) {
 	scrapeConfig.Labels = monitoringutils.Labels(shoot.Label)
-	scrapeConfig.Spec = k.standardScrapeConfigSpec(
-		"kube_daemonset_metadata_generation",
-		"kube_daemonset_status_current_number_scheduled",
-		"kube_daemonset_status_desired_number_scheduled",
-		"kube_daemonset_status_number_available",
-		"kube_daemonset_status_number_unavailable",
-		"kube_daemonset_status_updated_number_scheduled",
-		"kube_deployment_metadata_generation",
-		"kube_deployment_spec_replicas",
-		"kube_deployment_status_observed_generation",
-		"kube_deployment_status_replicas",
-		"kube_deployment_status_replicas_available",
-		"kube_deployment_status_replicas_unavailable",
-		"kube_deployment_status_replicas_updated",
-		"kube_node_info",
-		"kube_node_labels",
-		"kube_node_spec_taint",
-		"kube_node_spec_unschedulable",
-		"kube_node_status_allocatable",
-		"kube_node_status_capacity",
-		"kube_node_status_condition",
-		"kube_pod_container_info",
-		"kube_pod_container_resource_limits",
-		"kube_pod_container_resource_requests",
-		"kube_pod_container_status_restarts_total",
-		"kube_pod_info",
-		"kube_pod_labels",
-		"kube_pod_status_phase",
-		"kube_pod_status_ready",
-		"kube_replicaset_owner",
-		"kube_replicaset_metadata_generation",
-		"kube_replicaset_spec_replicas",
-		"kube_replicaset_status_observed_generation",
-		"kube_replicaset_status_replicas",
-		"kube_replicaset_status_ready_replicas",
-		"kube_statefulset_metadata_generation",
-		"kube_statefulset_replicas",
-		"kube_statefulset_status_observed_generation",
-		"kube_statefulset_status_replicas",
-		"kube_statefulset_status_replicas_current",
-		"kube_statefulset_status_replicas_ready",
-		"kube_statefulset_status_replicas_updated",
-		"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_cpu",
-		"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_target_memory",
-		"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_cpu",
-		"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_uncappedtarget_memory",
-		"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_cpu",
-		"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_upperbound_memory",
-		"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_cpu",
-		"kube_customresource_verticalpodautoscaler_status_recommendation_containerrecommendations_lowerbound_memory",
-		"kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_cpu",
-		"kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_minallowed_memory",
-		"kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_cpu",
-		"kube_customresource_verticalpodautoscaler_spec_resourcepolicy_containerpolicies_maxallowed_memory",
-		"kube_customresource_verticalpodautoscaler_spec_updatepolicy_updatemode",
-	)
+	scrapeConfig.Spec = k.standardScrapeConfigSpec()
 }
 
 func (k *kubeStateMetrics) emptyPrometheusRuleShoot() *monitoringv1.PrometheusRule {
-- 
2.44.0

